# å›¾åºŠé¡¹ç›®å®‰å…¨æ€§å®¡è®¡æŠ¥å‘Š

ç”Ÿæˆæ—¶é—´ï¼š2025å¹´12æœˆ21æ—¥

## âœ… å®‰å…¨ä¼˜åŠ¿ï¼ˆå·²åšå¥½çš„æ–¹é¢ï¼‰

### 1. **Tokenç”Ÿæˆå®‰å…¨** â­â­â­â­â­
- âœ… ä½¿ç”¨ `secrets.token_hex(32)` ç”ŸæˆTokenï¼ˆ64å­—ç¬¦ï¼Œ256ä½éšæœºæ€§ï¼‰
- âœ… å¯†ç å­¦å®‰å…¨çš„éšæœºæ•°ç”Ÿæˆå™¨
- âœ… Tokenæ ¼å¼ï¼š`guest_` + 64ä½åå…­è¿›åˆ¶å­—ç¬¦
- âœ… ç®¡ç†å‘˜Tokenï¼š`admin_` + 64ä½åå…­è¿›åˆ¶å­—ç¬¦
- âœ… åˆ†äº«Tokenï¼š`secrets.token_urlsafe(24)` ç”ŸæˆURLå®‰å…¨Token

### 2. **å¯†ç å®‰å…¨** â­â­â­â­â­
- âœ… ä½¿ç”¨ `werkzeug.security.generate_password_hash`
- âœ… ç®—æ³•ï¼š`pbkdf2:sha256`ï¼ˆPBKDF2 + SHA256ï¼‰
- âœ… å¯†ç éªŒè¯ï¼š`check_password_hash`
- âœ… æ— é»˜è®¤å¼±å¯†ç ï¼ˆå¿…é¡»è®¾ç½®æˆ–è‡ªåŠ¨ç”Ÿæˆï¼‰
- âœ… è‡ªåŠ¨ç”Ÿæˆå¯†ç ï¼š`secrets.token_urlsafe(12)`

### 3. **SQLæ³¨å…¥é˜²æŠ¤** â­â­â­â­â­
- âœ… **å®Œå…¨ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢**ï¼ˆæ‰€æœ‰SQLè¯­å¥ï¼‰
- âœ… ç¤ºä¾‹ï¼š`cursor.execute('SELECT * FROM auth_tokens WHERE token = ?', (token,))`
- âœ… æ— å­—ç¬¦ä¸²æ‹¼æŽ¥SQL
- âœ… ä½¿ç”¨ `?` å ä½ç¬¦ç»‘å®šå‚æ•°
- âœ… æ‰¹é‡æ“ä½œä½¿ç”¨ `placeholders = ','.join('?' * len(ids))`

### 4. **XSSé˜²æŠ¤** â­â­â­â­
- âœ… ç¦æ­¢SVGæ–‡ä»¶ä¸Šä¼ ï¼ˆXSSé£Žé™©ï¼‰
- âœ… æ–‡ä»¶ç±»åž‹éªŒè¯ï¼šé­”æ•°æ£€æŸ¥ + Content-Typeæ£€æŸ¥
- âœ… å‰ç«¯ä½¿ç”¨Vue/Nuxtï¼ˆè‡ªåŠ¨è½¬ä¹‰ï¼‰
- âš ï¸ å…¬å‘Šå†…å®¹æ”¯æŒHTMLï¼ˆç®¡ç†å‘˜åŠŸèƒ½ï¼Œé£Žé™©å¯æŽ§ï¼‰

### 5. **æ–‡ä»¶ä¸Šä¼ å®‰å…¨** â­â­â­â­
- âœ… **æ–‡ä»¶å¤§å°é™åˆ¶**ï¼ˆé»˜è®¤20MBï¼Œå¯é…ç½®ï¼‰
- âœ… **é­”æ•°éªŒè¯**ï¼ˆæ£€æŸ¥æ–‡ä»¶çœŸå®žç±»åž‹ï¼‰
- âœ… **MIMEç±»åž‹æ£€æŸ¥**
- âœ… **å…è®¸åˆ—è¡¨**ï¼šPNG, JPEG, GIF, WebP, BMP
- âœ… **ç¦æ­¢SVG**ï¼ˆXSSé˜²æŠ¤ï¼‰
- âœ… æ–‡ä»¶åé•¿åº¦é™åˆ¶ï¼ˆ200å­—ç¬¦ï¼‰

### 6. **è®¿é—®æŽ§åˆ¶** â­â­â­â­
- âœ… ç®¡ç†å‘˜Sessionè®¤è¯ï¼ˆHttpOnly Cookieï¼‰
- âœ… Tokenè¿‡æœŸæ£€æŸ¥
- âœ… Tokenå¯ç”¨/ç¦ç”¨çŠ¶æ€æ£€æŸ¥
- âœ… ä¸Šä¼ é…é¢é™åˆ¶
- âœ… æ¯æ—¥ä¸Šä¼ é™åˆ¶ï¼ˆå¯é…ç½®ï¼‰
- âœ… IPå’ŒUser-Agentè®°å½•

### 7. **æ•°æ®åº“å®‰å…¨** â­â­â­â­
- âœ… SQLite WALæ¨¡å¼ï¼ˆå¹¶å‘æ€§èƒ½ä¼˜åŒ–ï¼‰
- âœ… å¤–é”®çº¦æŸï¼ˆ`FOREIGN KEY ON DELETE CASCADE`ï¼‰
- âœ… ç´¢å¼•ä¼˜åŒ–ï¼ˆæŸ¥è¯¢æ€§èƒ½ï¼‰
- âœ… äº‹åŠ¡å¤„ç†ï¼ˆ`conn.commit()` / `conn.rollback()`ï¼‰
- âœ… é‡è¯•æœºåˆ¶ï¼ˆå¤„ç†æ•°æ®åº“é”å®šï¼‰

### 8. **é…ç½®å®‰å…¨** â­â­â­â­
- âœ… æ•æ„Ÿé…ç½®ä¸è®°å½•æ—¥å¿—ï¼ˆ`SENSITIVE_SETTINGS`ï¼‰
- âœ… Bot Token / API Token æ ‡è®°ä¸ºæ•æ„Ÿ
- âœ… æ—¥å¿—ä¸­æ˜¾ç¤º `[REDACTED]`

---

## âš ï¸ å®‰å…¨é£Žé™©ï¼ˆéœ€è¦æ”¹è¿›çš„æ–¹é¢ï¼‰

### 1. **å‰ç«¯Tokenå­˜å‚¨** ðŸ”´ **é«˜é£Žé™©**
**é—®é¢˜ï¼š** Tokenå­˜å‚¨åœ¨ `localStorage`
- âŒ æ˜“å—XSSæ”»å‡»çªƒå–
- âŒ æ— HttpOnlyä¿æŠ¤
- âŒ è·¨æ ‡ç­¾é¡µå…±äº«ï¼ˆå¯èƒ½æ³„éœ²ï¼‰

**å½±å“ï¼š**
- æ”»å‡»è€…å¯é€šè¿‡XSSèŽ·å–æ‰€æœ‰Token
- ç”¨æˆ·Tokenå¯èƒ½è¢«çªƒå–ç”¨äºŽä¸Šä¼ /æŸ¥çœ‹ç›¸å†Œ

**å»ºè®®ï¼š**
```javascript
// æ–¹æ¡ˆ1ï¼šä½¿ç”¨HttpOnly Cookieå­˜å‚¨Tokenï¼ˆæŽ¨èï¼‰
// åŽç«¯ï¼šSet-Cookie: auth_token=xxx; HttpOnly; Secure; SameSite=Strict

// æ–¹æ¡ˆ2ï¼šä½¿ç”¨SessionStorageï¼ˆè‡³å°‘æ¯”localStorageå¥½ï¼‰
sessionStorage.setItem('token_vault_v1', JSON.stringify(vault))

// æ–¹æ¡ˆ3ï¼šåŠ å¯†å­˜å‚¨
const encrypted = CryptoJS.AES.encrypt(JSON.stringify(vault), sessionKey).toString()
localStorage.setItem('token_vault_v1', encrypted)
```

---

### 2. **æ— CSRFä¿æŠ¤** ðŸ”´ **é«˜é£Žé™©**
**é—®é¢˜ï¼š** æ‰€æœ‰POST/PUT/DELETEè¯·æ±‚æ— CSRF Token
- âŒ ç®¡ç†å‘˜APIæ— CSRFä¿æŠ¤
- âŒ Tokenç”ŸæˆAPIæ— CSRFä¿æŠ¤
- âŒ å›¾ç‰‡ä¸Šä¼ APIæ— CSRFä¿æŠ¤

**å½±å“ï¼š**
- æ”»å‡»è€…å¯è¯±å¯¼ç®¡ç†å‘˜æ‰§è¡Œæ¶æ„æ“ä½œ
- å¯èƒ½è¢«ç”¨äºŽCSRFæ”»å‡»ä¸Šä¼ /åˆ é™¤å›¾ç‰‡

**å»ºè®®ï¼š**
```python
# 1. åŽç«¯ç”ŸæˆCSRF Token
from flask_wtf.csrf import CSRFProtect
csrf = CSRFProtect(app)

# 2. å‰ç«¯æ¯ä¸ªè¯·æ±‚æºå¸¦
headers: {
    'X-CSRF-Token': csrfToken
}

# 3. æˆ–ä½¿ç”¨Double Submit Cookieæ¨¡å¼
```

---

### 3. **Sessionå®‰å…¨é…ç½®ä¸è¶³** ðŸŸ¡ **ä¸­é£Žé™©**
**é—®é¢˜ï¼š** SESSION_COOKIE_SECURE é»˜è®¤ false
- âŒ HTTPè¿žæŽ¥ä¸‹Cookieä¸åŠ å¯†ä¼ è¾“
- âš ï¸ æ—  `Strict` çš„ SameSite è®¾ç½®

**å½“å‰é…ç½®ï¼š**
```python
SESSION_COOKIE_HTTPONLY = True  # âœ… å·²è®¾ç½®
SESSION_COOKIE_SAMESITE = 'Lax'  # âš ï¸ åº”æ”¹ä¸º 'Strict'
SESSION_COOKIE_SECURE = False  # âŒ HTTPSä¸‹åº”è®¾ä¸ºTrue
```

**å»ºè®®ï¼š**
```python
# æ ¹æ®çŽ¯å¢ƒè‡ªåŠ¨é…ç½®
SESSION_COOKIE_SECURE = not app.debug  # ç”Ÿäº§çŽ¯å¢ƒå¼ºåˆ¶HTTPS
SESSION_COOKIE_SAMESITE = 'Strict'  # æ›´ä¸¥æ ¼çš„CSRFé˜²æŠ¤
```

---

### 4. **æ— ç™»å½•é™æµ** ðŸŸ¡ **ä¸­é£Žé™©**
**é—®é¢˜ï¼š** æ— ç™»å½•å¤±è´¥æ¬¡æ•°é™åˆ¶
- âŒ å¯æš´åŠ›ç ´è§£ç®¡ç†å‘˜å¯†ç 
- âŒ æ— éªŒè¯ç ä¿æŠ¤
- âŒ æ— IPé»‘åå•

**å»ºè®®ï¼š**
```python
# ä½¿ç”¨Redisæˆ–å†…å­˜è®°å½•å¤±è´¥æ¬¡æ•°
login_attempts = {}  # {ip: {'count': 3, 'locked_until': timestamp}}

def check_login_attempts(ip):
    if ip in login_attempts:
        if login_attempts[ip]['count'] >= 5:
            if time.time() < login_attempts[ip]['locked_until']:
                return False, "è´¦æˆ·å·²é”å®šï¼Œè¯·30åˆ†é’ŸåŽå†è¯•"
    return True, None

# å¤±è´¥æ—¶å¢žåŠ è®¡æ•°
login_attempts[ip] = {
    'count': login_attempts.get(ip, {}).get('count', 0) + 1,
    'locked_until': time.time() + 1800  # 30åˆ†é’Ÿ
}
```

---

### 5. **æ— å®‰å…¨å“åº”å¤´** ðŸŸ¡ **ä¸­é£Žé™©**
**é—®é¢˜ï¼š** ç¼ºå°‘å…³é”®å®‰å…¨HTTPå¤´
- âŒ æ—  `Content-Security-Policy`
- âŒ æ—  `X-Content-Type-Options`
- âŒ æ—  `X-Frame-Options`
- âŒ æ—  `Strict-Transport-Security`

**å»ºè®®ï¼š**
```python
@app.after_request
def add_security_headers(response):
    response.headers['X-Content-Type-Options'] = 'nosniff'
    response.headers['X-Frame-Options'] = 'DENY'
    response.headers['X-XSS-Protection'] = '1; mode=block'
    if request.is_secure:
        response.headers['Strict-Transport-Security'] = 'max-age=31536000; includeSubDomains'
    # CSP (æ ¹æ®å®žé™…éœ€æ±‚è°ƒæ•´)
    response.headers['Content-Security-Policy'] = "default-src 'self'; img-src * data:; script-src 'self' 'unsafe-inline'"
    return response
```

---

### 6. **Tokenå¯è§æ€§é—®é¢˜** ðŸŸ¡ **ä¸­ä½Žé£Žé™©**
**é—®é¢˜ï¼š** ç®¡ç†å‘˜å¯çœ‹åˆ°æ‰€æœ‰ç”¨æˆ·çš„Tokenï¼ˆè™½ç„¶è„±æ•ï¼‰
- âš ï¸ å®Œæ•´Tokenåœ¨åˆ›å»ºæ—¶æ˜¾ç¤ºä¸€æ¬¡ï¼ˆæ­£å¸¸ï¼‰
- âš ï¸ ç®¡ç†å‘˜å¯é€šè¿‡æ•°æ®åº“ç›´æŽ¥æŸ¥è¯¢å®Œæ•´Token

**å½±å“ï¼š** ä½Žï¼ˆéœ€è¦æ•°æ®åº“è®¿é—®æƒé™ï¼‰

**å»ºè®®ï¼š**
- âœ… å·²è„±æ•æ˜¾ç¤ºï¼ˆ`guest_abc...xyz`ï¼‰
- å¯é€‰ï¼šå®Œæ•´Tokenå•å‘åŠ å¯†å­˜å‚¨ï¼ŒåªéªŒè¯ä¸æ˜¾ç¤º

---

### 7. **æ—¥å¿—å¯èƒ½æ³„éœ²æ•æ„Ÿä¿¡æ¯** ðŸŸ¢ **ä½Žé£Žé™©**
**é—®é¢˜ï¼š** éƒ¨åˆ†æ—¥å¿—å¯èƒ½åŒ…å«Tokenç‰‡æ®µ
- âš ï¸ `logger.info(f"åˆ›å»ºæ–°çš„auth_token: {token[:20]}...")`
- âš ï¸ é”™è¯¯æ—¥å¿—å¯èƒ½åŒ…å«å®Œæ•´å‚æ•°

**å»ºè®®ï¼š**
```python
# å®Œå…¨éšè—Token
logger.info(f"åˆ›å»ºæ–°çš„auth_token: [HIDDEN]")

# æˆ–ä½¿ç”¨è„±æ•å‡½æ•°
def mask_sensitive(text):
    # æ›¿æ¢æ‰€æœ‰ç±»ä¼¼Tokençš„å­—ç¬¦ä¸²
    return re.sub(r'guest_[0-9a-f]{64}', 'guest_[REDACTED]', text)
```

---

## ðŸ“Š å®‰å…¨è¯„åˆ†

| å®‰å…¨ç»´åº¦ | è¯„åˆ† | è¯´æ˜Ž |
|---------|------|------|
| **å¯†ç å­¦å®‰å…¨** | â­â­â­â­â­ | Tokenç”Ÿæˆã€å¯†ç å“ˆå¸Œéƒ½ä½¿ç”¨äº†ä¸šç•Œæœ€ä½³å®žè·µ |
| **SQLæ³¨å…¥é˜²æŠ¤** | â­â­â­â­â­ | å®Œå…¨ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢ï¼Œæ— é£Žé™© |
| **XSSé˜²æŠ¤** | â­â­â­â­ | æ–‡ä»¶ç±»åž‹éªŒè¯ä¸¥æ ¼ï¼Œå‰ç«¯è‡ªåŠ¨è½¬ä¹‰ |
| **è®¤è¯å®‰å…¨** | â­â­â­ | Sessionè®¤è¯å¯é ï¼Œä½†ç¼ºå°‘CSRFå’Œé™æµ |
| **Tokenç®¡ç†** | â­â­â­ | Tokenç”Ÿæˆå®‰å…¨ï¼Œä½†å‰ç«¯å­˜å‚¨æœ‰é£Žé™© |
| **æ–‡ä»¶ä¸Šä¼ ** | â­â­â­â­ | å¤šé‡éªŒè¯ï¼Œå¤§å°é™åˆ¶åˆç† |
| **æ€»ä½“è¯„åˆ†** | **â­â­â­â­ (4/5)** | æ ¸å¿ƒå®‰å…¨åšå¾—å¾ˆå¥½ï¼Œéœ€æ”¹è¿›è¾¹ç¼˜é˜²æŠ¤ |

---

## ðŸŽ¯ ä¼˜å…ˆçº§æ”¹è¿›å»ºè®®

### **é«˜ä¼˜å…ˆçº§ï¼ˆå¿…é¡»ä¿®å¤ï¼‰**
1. âœ… **æ·»åŠ CSRFä¿æŠ¤** - é˜²æ­¢è·¨ç«™è¯·æ±‚ä¼ªé€ 
2. âœ… **æ”¹è¿›Tokenå­˜å‚¨** - ä½¿ç”¨HttpOnly Cookieæˆ–åŠ å¯†localStorage
3. âœ… **å¼ºåˆ¶HTTPSé…ç½®** - SESSION_COOKIE_SECURE = True

### **ä¸­ä¼˜å…ˆçº§ï¼ˆå»ºè®®ä¿®å¤ï¼‰**
4. âœ… **æ·»åŠ ç™»å½•é™æµ** - é˜²æ­¢æš´åŠ›ç ´è§£
5. âœ… **æ·»åŠ å®‰å…¨å“åº”å¤´** - æå‡æ•´ä½“å®‰å…¨æ€§
6. âœ… **å®Œå–„æ—¥å¿—è„±æ•** - é¿å…æ•æ„Ÿä¿¡æ¯æ³„éœ²

### **ä½Žä¼˜å…ˆçº§ï¼ˆå¯é€‰ï¼‰**
7. ðŸ“ Tokenå®Œå…¨åŠ å¯†å­˜å‚¨
8. ðŸ“ æ·»åŠ éªŒè¯ç ï¼ˆCaptchaï¼‰
9. ðŸ“ å®žæ–½IPç™½åå•/é»‘åå•

---

## ðŸ”’ ç»“è®º

**æ€»ä½“å®‰å…¨æ€§ï¼šè‰¯å¥½ âœ…**

é¡¹ç›®åœ¨**æ ¸å¿ƒå®‰å…¨**æ–¹é¢åšå¾—éžå¸¸å¥½ï¼š
- Tokenç”Ÿæˆä½¿ç”¨äº†å¯†ç å­¦å®‰å…¨çš„éšæœºæ•°
- å¯†ç å­˜å‚¨ä½¿ç”¨äº†PBKDF2
- SQLå®Œå…¨é˜²æ³¨å…¥
- æ–‡ä»¶ä¸Šä¼ æœ‰ä¸¥æ ¼éªŒè¯

ä¸»è¦é£Žé™©åœ¨äºŽï¼š
- å‰ç«¯Tokenå­˜å‚¨ï¼ˆlocalStorage XSSé£Žé™©ï¼‰
- ç¼ºå°‘CSRFä¿æŠ¤
- Sessioné…ç½®å¯ä¼˜åŒ–

**å»ºè®®ä¼˜å…ˆè§£å†³å‰ä¸¤ä¸ªé«˜é£Žé™©é—®é¢˜ï¼Œå³å¯è¾¾åˆ°ç”Ÿäº§çŽ¯å¢ƒçš„å®‰å…¨æ ‡å‡†ã€‚**

---

## ðŸ“ å®‰å…¨æ£€æŸ¥æ¸…å•

- [x] ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢ï¼ˆSQLæ³¨å…¥é˜²æŠ¤ï¼‰
- [x] å¯†ç ä½¿ç”¨PBKDF2å“ˆå¸Œ
- [x] Tokenä½¿ç”¨secretsæ¨¡å—ç”Ÿæˆ
- [x] æ–‡ä»¶ä¸Šä¼ é­”æ•°éªŒè¯
- [x] ç¦æ­¢SVGä¸Šä¼ 
- [x] Sessionä½¿ç”¨HttpOnly
- [ ] æ·»åŠ CSRF TokenéªŒè¯
- [ ] å‰ç«¯Tokenä½¿ç”¨HttpOnly Cookie
- [ ] å¼ºåˆ¶HTTPSï¼ˆSESSION_COOKIE_SECUREï¼‰
- [ ] æ·»åŠ ç™»å½•é™æµ
- [ ] æ·»åŠ å®‰å…¨å“åº”å¤´
- [ ] å®Œå–„æ—¥å¿—è„±æ•

---

ç”Ÿæˆæ—¶é—´ï¼š{{ date }}
å®¡è®¡å·¥å…·ï¼šäººå·¥ä»£ç å®¡æŸ¥
