name: Docker Build and Push

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'LICENSE'
      - '.gitignore'
  workflow_dispatch:
    inputs:
      release_type:
        description: 'å‘å¸ƒç±»å‹'
        required: true
        default: 'beta'
        type: choice
        options:
          - beta
          - latest

env:
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/tg-telegram-imagebed

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¾ç½®Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ç™»å½•Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: è·å–Betaç‰ˆæœ¬å·
        id: beta_version
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.release_type == 'beta'
        run: |
          # è·å–æ‰€æœ‰betaæ ‡ç­¾
          git fetch --tags
          LATEST_BETA=$(git tag -l "beta-*" | sort -V | tail -n 1)
          
          if [ -z "$LATEST_BETA" ]; then
            # å¦‚æœæ²¡æœ‰betaæ ‡ç­¾ï¼Œä»beta-1å¼€å§‹
            NEW_BETA="beta-1"
          else
            # æå–æ•°å­—å¹¶é€’å¢
            BETA_NUM=$(echo $LATEST_BETA | sed 's/beta-//')
            NEW_NUM=$((BETA_NUM + 1))
            NEW_BETA="beta-${NEW_NUM}"
          fi
          
          echo "version=$NEW_BETA" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ æ–°çš„Betaç‰ˆæœ¬: $NEW_BETA"

      - name: åˆ›å»ºBeta Gitæ ‡ç­¾
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.release_type == 'beta'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag ${{ steps.beta_version.outputs.version }}
          git push origin ${{ steps.beta_version.outputs.version }}

      - name: å‡†å¤‡Dockeræ ‡ç­¾ï¼ˆLatestï¼‰
        id: meta_latest
        if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.release_type == 'latest')
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest
            type=sha,prefix={{date 'YYYYMMDD'}}-

      - name: å‡†å¤‡Dockeræ ‡ç­¾ï¼ˆBetaï¼‰
        id: meta_beta
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.release_type == 'beta'
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=${{ steps.beta_version.outputs.version }}
            type=raw,value=beta

      - name: æ„å»ºå¹¶æ¨é€Dockeré•œåƒï¼ˆLatestï¼‰
        if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.release_type == 'latest')
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta_latest.outputs.tags }}
          labels: ${{ steps.meta_latest.outputs.labels }}
          platforms: linux/amd64,linux/arm64
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: æ„å»ºå¹¶æ¨é€Dockeré•œåƒï¼ˆBetaï¼‰
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.release_type == 'beta'
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta_beta.outputs.tags }}
          labels: ${{ steps.meta_beta.outputs.labels }}
          platforms: linux/amd64,linux/arm64
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: è¾“å‡ºé•œåƒä¿¡æ¯
        run: |
          echo "ğŸ‰ Dockeré•œåƒæ„å»ºæˆåŠŸï¼"
          echo ""
          echo "ğŸ“‹ é•œåƒä¿¡æ¯ï¼š"
          if [ "${{ github.event_name }}" == "push" ] || [ "${{ github.event.inputs.release_type }}" == "latest" ]; then
            echo "  - ${{ env.IMAGE_NAME }}:latest"
            echo "  - ${{ env.IMAGE_NAME }}:$(date +%Y%m%d)-$(git rev-parse --short HEAD)"
          else
            echo "  - ${{ env.IMAGE_NAME }}:${{ steps.beta_version.outputs.version }}"
            echo "  - ${{ env.IMAGE_NAME }}:beta"
          fi
          echo ""
          echo "ğŸš€ æ‹‰å–å‘½ä»¤ï¼š"
          if [ "${{ github.event_name }}" == "push" ] || [ "${{ github.event.inputs.release_type }}" == "latest" ]; then
            echo "  docker pull ${{ env.IMAGE_NAME }}:latest"
          else
            echo "  docker pull ${{ env.IMAGE_NAME }}:${{ steps.beta_version.outputs.version }}"
            echo "  docker pull ${{ env.IMAGE_NAME }}:beta"
          fi
