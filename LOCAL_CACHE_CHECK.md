# 本地缓存使用说明

## 🔧 默认状态
- **本地缓存默认关闭**，需要在管理后台手动开启
- 开启后才会缓存新上传的图片
- 已有图片不会自动缓存，只有被访问时才会缓存

## 📍 如何确认图片来自本地缓存

### 方法 1: 查看浏览器开发者工具（推荐）

1. 打开浏览器的开发者工具 (F12)
2. 切换到 **Network（网络）** 标签页
3. 访问图片链接
4. 点击图片请求，查看 **Response Headers（响应头）**

#### 关键响应头：

```
X-Storage-Backend: local-cache     # 表示从本地缓存返回
X-Cache-Hit: true                  # 表示命中缓存
```

如果是从 Telegram 拉取：
```
X-Storage-Backend: telegram        # 表示从 Telegram 返回
X-Cache-Hit: false                 # 表示未命中缓存
```

### 方法 2: 使用 curl 命令

```bash
curl -I https://your-domain.com/image/xxxxxxx
```

查看输出中的：
- `X-Storage-Backend: local-cache` - 来自本地缓存
- `X-Cache-Hit: true` - 命中缓存

### 方法 3: 管理后台查看

1. 进入 **管理后台 > 图片管理**
2. 点击图片卡片查看详情
3. 在详情模态框中：
   - **蓝色徽章 "本地缓存"** - 表示该图片已缓存到本地
   - **灰色状态 "未缓存"** - 表示该图片未缓存

## 📊 仪表盘统计

管理后台首页显示：
- **本地缓存文件数**
- **本地缓存总大小**
- **存储路径**（默认 `/app/image`）

## 🔍 工作流程

### 图片访问流程：

1. **检查开关**：是否启用本地缓存？
2. **检查缓存**：本地文件是否存在？
   - ✅ 存在 → 直接返回（设置 `X-Storage-Backend: local-cache`）
   - ❌ 不存在 → 从 Telegram 拉取并缓存（设置 `X-Storage-Backend: telegram`）

### 上传图片流程：

1. 图片上传到 Telegram
2. **检查开关**：是否启用本地缓存？
   - ✅ 启用 → 同时保存到 `/app/image`
   - ❌ 关闭 → 只保存到 Telegram

## 📁 缓存存储位置

### 默认路径
```
/app/image/
```

### 自定义路径
在 **管理后台 > 系统设置 > 本地缓存配置** 中设置：
- 留空使用默认路径 `/app/image`
- 填写相对路径如 `/cache` 则使用 `/app/cache`
- **容器内路径**，需要在 docker-compose.yml 中挂载

### Docker 挂载示例

```yaml
services:
  tg-imagebed:
    volumes:
      - ./data:/app/data          # 数据库
      - ./cache:/app/image        # 本地缓存（默认）
```

## ⚙️ 配置说明

### 数据库配置
- `local_cache_enabled`: '0' = 关闭, '1' = 开启（默认关闭）
- `local_cache_path`: 自定义路径（默认为空）

### 前端配置
管理后台 > 系统设置 > 本地缓存配置：
1. **开关按钮**：启用/禁用本地缓存
2. **路径输入**：自定义缓存目录
3. **工作原理**：显示缓存机制说明

## 🧪 测试步骤

1. **开启缓存**
   - 进入管理后台 > 系统设置
   - 开启 "本地缓存" 开关
   - 保存设置

2. **上传测试图片**
   - 上传一张新图片
   - 查看 `/app/image` 目录（容器内）
   - 应该看到新文件

3. **访问图片**
   - 在浏览器中打开图片链接
   - 打开开发者工具查看响应头
   - 确认 `X-Storage-Backend: local-cache`

4. **验证管理后台**
   - 刷新仪表盘，查看缓存统计
   - 进入图片管理，查看蓝色 "本地缓存" 徽章

## ❓ 常见问题

### Q: 为什么开启后，已有图片没有缓存？
A: 只有新上传或被访问的图片才会缓存。首次访问时从 Telegram 拉取并缓存。

### Q: 如何清空本地缓存？
A: 删除 `/app/image` 目录下的所有文件，或在管理后台使用清理功能。

### Q: 缓存会自动更新吗？
A: 图片内容不会变化（加密 ID 不变），所以缓存是永久的。

### Q: 关闭缓存后，已有缓存会删除吗？
A: 不会自动删除，只是不再使用和新增缓存。需要手动清理。

## 📝 日志查看

Docker 日志中会显示：
```
INFO - 从本地缓存返回图片: abc123... (访问类型: direct_access)
```

表示图片从本地缓存返回。
